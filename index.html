<html>
    <head>
        <meta name='viewport' content='width=device-width'/>
        <link rel="stylesheet" href="ui.css">
        <link rel="stylesheet" href="selector.css">
        <title>Pixel Renderer</title>
        <style>
            body {margin: 0;}
            canvas {width: 100%; height: 100%};
            #header{background-color: #2E2E2E; width: 100%; height: 100%}
        </style>
    </head>

    <body>
        <div id="main" class="parent">

            <div id="header" class="header">
                <p class="header-logo">Pixel Renderer</p>
                <input type="file" name="loader" id="loader" class="header-content"onchange="changeCubeColor()"/>
            </div>
            
            <div id="selector" class="selector">
                <div id="info">
                    <button type="button" onclick="createButton()" class="add-character-btn"><b>+</b> Add New Character</button>
                    <div id="character-list" >
                    <script src="three/three.js"></script>
                    <script>
                        //TODO: Fix clicking on toggle show character list changing selection
                        //      to the clicked character
                        //TODO: Separate everything in classes
                        var char_names = []
                        var ph_names = ["walk", "run", "idle", "wallclimb", "jump",
                                        "ladderclimb", "attack1", "attack2", "cast1", 
                                        "castcomplete", "newcast", "rapier1", "rapier2",
                                        "rapierjump", "rapierair", "axe1", "axe2", "axejump",
                                        "sword1", "sword2", "sword3", "swordjump", "ultimate1",
                                        "ultimate2", "ultimate3", "holycast", "holycast2",
                                        "holycastcompleted", "darkmageidle","dakrmagejump",
                                        "icemagecast", "icenovacastcompleted", "teleport",
                                        "dash", "quickdash", "dodge", "open door", "kick"]
                        //var ph_names = ["walk", "run", "idle", "wallclimb", "jump"]
                        char_list = document.getElementById("character-list");
                        var selected_button = null;
                        var cur_txt = null;
                        var cur_exp = null;

                        function click_expand(index)
                        {
                            exp = document.getElementById("char_el_expand_"+index);
                            tst = document.getElementById("anim_cont_"+index);
                            console.log(tst);
                            
                            if(exp.childNodes[0].nodeValue === ">")
                            {
                                exp.childNodes[0].nodeValue = "v";
                                tst.style.height = 'auto';
                                var endHeight = getComputedStyle(tst).height; //max height
                                tst.style.height = '0px';//go back to 0
                                tst.style.transition = 'height 300ms ease-in-out';
                                tst.offsetHeight;
                                tst.style.height = endHeight

                                tst.addEventListener('transitionend', function transitionEnd(event) {
                                    if (event.propertyName == 'height') {
                                        tst.style.transition = ''
                                        tst.style.height = 'auto'
                                        tst.removeEventListener('transitionend', transitionEnd, false)
                                    }
                                }, false)
                                
                            }
                            else
                            {
                                exp.childNodes[0].nodeValue = ">";

                                tst.style.height = getComputedStyle(tst).height;
                                tst.style.transition = 'height 300ms ease-in-out';
                                tst.offsetHeight;
                                tst.style.height = '0px';
                            }
                            
                            //tst.classList.toggle('open');

                        }

                        function selectDiv(index)
                        {
                            console.log(index);
                            char_el = document.getElementById("char_el"+index);
                            txt = document.getElementById("char_el_txt_"+index);
                            exp = document.getElementById("char_el_expand_"+index);
                            
                            if(selected_button != null)
                            {
                                selected_button.className = "button-default";
                                cur_txt.className = "character-txt-default";
                                cur_exp.className = "character-expand-default";
                            }

                            selected_button = char_el;
                            cur_txt = txt;
                            cur_exp = exp;

                            selected_button.className = "button-selected";
                            cur_txt.className = "character-txt-selected";
                            cur_exp.className = "character-expand-selected";
                        }

                        function createButton()
                        {
                            char_names.push("New Character");
                            var i = char_names.length - 1;

                            var char_el = document.createElement("div");
                            char_el.id = "char_el" + i.toString();
                            char_el.className = "button-default";
                            char_el.setAttribute( "onclick", "selectDiv("+i+")" );

                            var char_container = document.createElement("div");
                            char_container.id = "char_cont_" + i.toString();
                            
                            
                            char_list.appendChild(char_container);
                            
                            var t = document.createTextNode(char_names[i]);
                            var txt = document.createElement("input");
                            txt.id = "char_el_txt_"+i;
                            txt.setAttribute("type", "text");
                            txt.setAttribute("value", "New Character");
                            txt.className = "character-txt-default";
                            txt.readOnly = true;
                            txt.ondblclick = function(){txt.readOnly = false;}
                            txt.onkeypress = function(e){
                                if (!e) e = window.event;
                                var keyCode = e.keyCode || e.which;
                                if (keyCode == '13'){
                                    txt.readOnly = true;
                                    return;
                                }
                            }
                            
                            var expand = document.createElement("button");
                            expand.className = "character-expand-default";
                            expand.id = "char_el_expand_"+i;
                            exp_txt = document.createTextNode("v");
                            expand.appendChild(exp_txt);
                            expand.setAttribute( "onclick", "click_expand("+i+")" );

                            char_el.appendChild(expand);
                            char_el.appendChild(txt);

                            char_container.appendChild(char_el);


                            var anim_container = document.createElement("div")
                            anim_container.id = "anim_cont_"+i;
                            anim_container.className = "character_list";
                            char_container.appendChild(anim_container);

                            var tst = document.createElement("button");
                            tst.id = "tst_" + i.toString();
                            tst.className = "char_list_element";
                            var tsname = document.createTextNode("+ Add anim");
                            tst.appendChild(tsname);

                            anim_container.appendChild(tst);

                            for(i = 0; i < ph_names.length; i++)
                            {
                                var n = document.createElement("button");
                                n.className = "char_list_element";
                                var t = document.createTextNode(ph_names[i]);
                                //tst.style.height = 40 * i+1 + 'px';
                                n.appendChild(t);
                                anim_container.insertBefore(n, tst);
                            }
                      
                        }

                    </script>
                    </div>
                </div>
            </div>

            <div id="material" class=material></div>

            <div id="preview" class=preview>,
                <div class="slidecontainer">
                    <input type="range" min="0.1" max="1" step="0.01" value="1" class="slider" id="slider" onchange="">
                </div>
                <script src="three/three.js"></script>
                <script id="xesq" class=preview>

                    container = document.getElementById("preview")
                    var scene = new THREE.Scene();
                    scene.background = new THREE.Color(0xf5f5f5);
                    
                    scr_x_size = (window.innerWidth-(window.innerWidth*0.45)-12);
                    scr_y_size = (window.innerHeight-(window.innerHeight*0.07));
                    var aspect = scr_x_size/scr_y_size;
                    var frustum_size = 5;

                    var camera = new THREE.OrthographicCamera(aspect*frustum_size/-2, aspect*frustum_size/2, frustum_size/2, frustum_size/-2, 0.1, 100);
                    var renderer = new THREE.WebGLRenderer({antialias: false});
                    
                    var ratio = 1;
                    renderer.setSize( scr_x_size, scr_y_size);
                    
                    
                    container.appendChild(renderer.domElement);
                    var geometry = new THREE.BoxGeometry( 1, 1, 1 );
                    var material = new THREE.MeshBasicMaterial( { color: 0x00ff00 } );
                    var cube = new THREE.Mesh( geometry, material );
                    scene.add( cube );
                    camera.position.z = 5;
                    
                    
                    var slider = document.getElementById("slider");
                    slider.addEventListener("input", function(){ratio=slider.value; slider.change()});
                    window.addEventListener( 'resize', onWindowResize, false );
                    
                    function onWindowResize()
                    {
                        scr_x_size = (window.innerWidth-(window.innerWidth*0.45)-12);
                        scr_y_size = (window.innerHeight-(window.innerHeight*0.07));
                        aspect = scr_x_size/scr_y_size;
                        
                        camera.left = aspect*frustum_size/-2;
                        camera.right = aspect*frustum_size/2;
                        camera.top = frustum_size/2;
                        camera.bottom = frustum_size/-2;
                        
                        camera.updateProjectionMatrix();
                        renderer.setSize( scr_x_size, scr_y_size);
                    }    

                    function changeCubeColor()
                    {
                        console.log("oia");
                        cube.material.color.setHex(Math.random()*0xffffff);
                    }

                    var update = function()
                    {
                        renderer.setPixelRatio(ratio);
                    };
            
                    var render = function()
                    {
                        renderer.render(scene, camera);
                    };
            
                    var GameLoop = function()
                    {
                        cube.rotation.x += 0.01;
                        cube.rotation.y += 0.01;
                        requestAnimationFrame(GameLoop);
                        update();
                        render();
                    }
                    GameLoop();
                </script>
            </div>
            
        </div>
            
    </body>
</html>